Источники логов

auth, cron, kernel, mail, user, daemons, & etc

Приоритет логов

0 – emerg – emergency – “Писец! Все пропало! Поздняк метаться!” 
1 – alert – тревога! - “Ау! Я ща упаду, а тебе жопу надерут!”
2 – crit – critical – Критическое событие. 
3 – err – errors - Ошибка
4 – warning - Предупреждение
5 – notice - Замечание
6 – info - Информационное
7 – debug -  Событие отладки

Назначение логов

- Файл
- Консоль
- Конвейр
- Удаленная система
- Группа пользователей
- ..

Службы сбора логов 

syslog – устаревшая, в настоящее время не используется
rsyslog – 
journald -  
 
rsyslog – rocket syslog – принимает информацию с источников и передает в различные назначения, может обрабатывать огромное количество сообщений в секунду (вроде как более миллиона)
- расширенные возможностей фильтрации логов в сравнении с обычным syslog(валит все в один файл), можно создавать много фильтров, включая фильтрацию по регулярным выражениям
- может использоать протокол TCP  

!!! /etc/rsyslog.conf – конфигурация rsyslog

#### MODULES #### 

модули ввода, начинаются на im- 

module(load=”imuxsock”) # provides support for local system logging 
…
--MARK--  – это спец.сообщения, говорят что сервер логирования жив, просто ничего не происходит

#### GLOBAL DIRECTIVES ####
$[параметр][значение]

$ActionFileDefaultTemplate RSYSLOG_TraditionalFileFormat 
…..

$FileOwner root
…..

##### RULES ####

[источник].[приоритет]	имя файла
auth,authpriv.*		/var/log/auth.log
*.*;auth,authpriv.none	-/var/log/syslog
#cron.*			/var/log/cron.log
daemon.*			-/var/log/daemon.log
kern.*				-/var/log/kern.log
lpr.*				-/var/log/lpr.log
mail.*				-/var/log/mail.log
user.*				-/var/log/user.log


/var/log – журналы службы, обычные текстовые

/var/log/syslog — это основной системный журнал. Туда пишется все с момента запуска системы, служб, информация об устройствах, состояния сетевых служб и т.д. Если в системе что-то не работает или работает не так как надо, то в этот журнал стоит заглянуть в первую очередь, скорее всего ответ будет именно там.

/var/log/auth.log  — это информация об авторизации пользователей, а также информация о использованных механизмах аутентификации. В этот лог записываются как удачные, так и не удачные попытки входа всех пользователей. Если подключение удаленное, то также будет виден ip c которого подключились. В этот же лог записываются все изменения касающиеся списка пользователей и групп пользователей. Но тут, на всякий случай нужно помнить, что факт создания нового пользователя будет записан в лог только в том случае если пользователь создавался из графического интерфейса или из терминала, командой useradd. Если вписать пользователя руками в файлы /etc/passwd (список всех пользователей системы) и /etc/shadow (там в зашифрованном виде хранятся пароли) то записей в журнале не будет. Правда они все равно появятся когда пользователь войдет в систему, но помнить об этом моменте нужно.

/var/log/dpkg.log — лог менеджера пакетов. Название может отличаться в зависимости от используемого в системе менеджера пакетов;

/var/log/faillog — лог неудачных попыток входа в систему;

# who – Информация хранится там временно, только пока пользователь в системе. Если пользователей выйдет, запись удалится. Т.е. эта команда показывает только актуальные данные. 
# last -- Если нужно выяснить когда пользователь заходил в систему и сколько времени в ней находился то эта инфа хранится в логе /var/log/wtmp.
# last dstoun
# lastlog -- показывает список всех пользователей системы с датами их последнего входа.
Способы чтения логов
Файлы логов можно читать любой утилитой просмотра текста: tail, cat или less
May 15 06:26:33 – дата и время регистрации сообщений
user_name – имя компьютера с которого пришло сообщение
systemd-logind – источник события 
[452] – ID процесса, отправившего сообщение
: ‘massage’ – текст сообщения
Искать традиционно можно grep по параметрам
# tail -f /var/log/apach2/error.log команда для отслеживания лога в режимер реального времени (без -f покажет последние 10 строк лога)
# lnav -- утилита просмотра логов (нужна одноименная установка). Без аргументов покажет syslog
# lnav /var/log/auth.log /var/log/dpkg.log - можно просто перечислить логи после команды и зырить
# lnav -r -- просмотр заархивированного лога

Ротация логов – logrotate – автоматическая обработка всех логов которые на данный момент хранятся в системе. Основное предназначение – избавляться от гигантских логфайлов. Она умеет их отправлять о почте, архивировать и т.д., главное – сохранять файл лога при достижении определенных параметров в определенное место (в файл с точкой), создавая при этом новый пустой файл лога. 
Скрипт ежедневного задания ротации в планировщике cron.
/etc/cron.daily/logrotate  

/etc/logrotate.conf – файл конфигурации 

etc/logrotate.d – папка со скриптами logrotate

mountly; weekly; daily - периодичность
rotate n – n это колличество файлов с сохраненными логами
missingok – если отсутствует то все в порядке
notifempety – если файл пуст, ротация выполнятся не будет
compress – сжимать
delaycompress – сжимать перыдущую версию архива лога
create 664 root root – права, пользователь, группа создаваемого файла
minsize – максимальный размер файла логов после которого будет выполнена ротация

klogd – kernel log daemon – демон записи логов ядра. 

В настояшее время rsyslog сам читает логи ядра. busybox-syslogd



journald – служба сбора логов systemd, управляется утилитой journalctl (journal control)

/etc/systemd/journald.conf – файл настройки 

/run/log/journal/ - 

/var/log/journald/ - в этой папке лежит папка с бинарными файлами. 

# journalctl –list-boots – посмотреть все запуски системы.  0 – текущая, - 1 – предыдущая, и так далее. 

# journalctl -b ‘n’ – логи конкретной загрузки. n – номер загрузки

# journalctl -u NetworkManager – лог службы (-u  -- unit)

# journalctl -k – сообщения ядра системы (-k kernel)

# systemd-analyze – общее время загрузки системы

# systemd-analyze blame – сколько времени загружалась каждая служба, медленные процессы будут сверху.

# journalctl -p err -b 0 – вывод лога отфильтрованного по приоритету

!!!

# journalctl –disk-usage – узнать сколько места на диске занимают файлы журнала

# journalctc –vacuum-size=1G – ограничение объема журнала

# journalctl --vacuum-time=1years  – ограничение журнала по времени

# journalctl –-since 15:00  – показать все события с указанного времени

# journalctl –-since 15:00 –until 15:30  – показать все события в указанный период

# journalctl --yesterday  -- показать все события за вчера

# journalctl -n  k – показать последние сообщения где k – количество последних записей в журнале (по умолчанию без k выведет последние 10 строчек)

# journalctl -f  – смотреть логи в режиме реального времени. Добавлять можно сколь угодно флагов, и смотреть логи по конкретному юниту, юзеру и так далее

 Прием/отправка логов с/на удаленного хоста:

# systemd-journal-remote  – запустить демона на удаленном хосте

# systemd-journal-remote – url https://nnn.nnn.n.nn:3535 (порт уточнить)  – забрать логи с удаленного хоста

# systemd-journal-upload – url https://nnn.nnn.n.nn:3535 (порт уточнить)  – отправить логи на удаленный хост
